jobs:
  - job: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    strategy:
      matrix:
        Linux:
          vmImage: ubuntu-18.04

        ${{ if parameters.cross }}:
          MacOS:
            vmImage: macOS-10.15
          #Windows:
          #  vmImage: windows-2019
    pool:
      vmImage: $(vmImage)

    steps:
#      - task: PowerShell@2
#        inputs:
#          targetType: 'inline'
#          script: |
#            Remove-Item -LiteralPath "C:\msys64\" -Force -Recurse
#            choco install llvm
#            refreshenv
#        condition: eq( variables['Agent.OS'], 'Windows_NT' )
      - template: azure-install-rust.yml
        parameters:
          rust_version: ${{ parameters.rust }}
      - template: azure-install-sccache.yml
      - script: cargo test --verbose --all-features --workspace --lib --tests
        env:
          RUST_BACKTRACE: 1
        displayName: cargo test --lib --tests
        workingDirectory: $(Build.SourcesDirectory)