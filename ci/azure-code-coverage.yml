trigger: none

schedules:
  - cron: "0 0 * * *"
    displayName: Nightly code coverage run
    branches:
      include:
        - master
        - server-prototype

variables:
    RUSTFLAGS: -Dwarnings

jobs:
  - job: Code_coverage
    displayName: Code coverage

    pool:
      vmImage: ubuntu-18.04

    steps:
      - template: azure-install-rust.yml
        parameters:
          rust_version: 1.55.0
      - template: azure-install-sccache.yml

      - script: cargo install cargo-tarpaulin
        displayName: Install Tarpaulin
        workingDirectory: $(Build.SourcesDirectory)

      - script: cargo tarpaulin --ignore-tests -o Xml -t 600 --exclude-files demos form_derive agent_derive --avoid-cfg-tarpaulin
        displayName: Generate code coverage
        workingDirectory: $(Build.SourcesDirectory)

      - bash: |
          curl -Os https://uploader.codecov.io/latest/linux/codecov
          chmod +x codecov
          ./codecov -t ${CODECOV_TOKEN}
        displayName: Upload code coverage
        workingDirectory: $(Build.SourcesDirectory)
